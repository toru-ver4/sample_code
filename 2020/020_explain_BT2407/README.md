# BT.2020 to BT.709 の Gamut 変換が実装できた

## 1. はじめに

この記事は「Report ITU-R BT.2407 の Annex2 を実装」シリーズの3回目です。
かなり間が空きましたが失踪せずに少しずつ実装を進めていました。
無事に Rev01 の実装が完了したので結果を報告したいと思います。

## 2. 目的

BT.2407 Annex2 に記載の BT.2020 to BT.709 の Gamut Mapping を実装する。

自身の環境を踏まえて以下の点を意識した実装とする。

### ①Limited Range の信号前提ではなく Full Range の信号を前提とした処理とする。

BT.2407 Annex2 は NHKが考案した方式ということもあり、現在のTV放送に使用されている Limited Range の信号（940Lv～1019Lv の Overwhite 領域も含む）で扱えるように、CIELAB色空間を少し拡張して処理を行っている。

一方で自分は基本的に RGB444 Full Range の信号処理にしか興味が無いため、Limited Range を考慮した処理は行わないこととした。

### ②DCI-P3 to BT.709 の変換も視野に入れた実装とする

BT.2407 Annex2 は BT.2020 to BT.709 変換に最適化したアルゴリズムとなっている。が、自分は BT.2020 以外にも DCI-P3 の信号も扱うことが多い。そのため将来的には本実装を DCI-P3 to BT.709 変換にも応用したいと考えている。

こうした背景もあり BT.2407 Annex2 の Hue Mapping は今回の実装には盛り込まないこととした。
理由は BT.2020 to BT.709 に特化したマジックナンバーが複数あり、DCI-P3 to BT.709 変換への応用が困難だと判断したからである（※）。

※偉そうに書いていますが、要は自分の頭ではマジックナンバーの意味を正しく理解することが無理だったということです。おバカでごめんなさい…。

## 3. 結論

なんとか実装した。また簡単に扱えるように 3DLUT化も行った。

(BT.2020のディスプレイが無いと判断できないのだが)作成したテストパターンへの適用結果を図1に、128x128x128のカラーパッチに対する変換結果を図2に示す。

なお、図2は 3DLUTを使った変換結果も含んでいる。図の見方は記事の後半に書いてあるので、ここでは詳細を省略する。

作成した 3DLUT はココに置いた（使う人は居ないと思いますがトラブルが発生しても責任は負えません）。

## 4. 理論

### 4.1 概要

BT.2407 Annex2 の Gamut Mapping について簡単に説明する。

まず大前提として Gamut Mapping は CIELAB色空間で行う。IPT や CIECAM02 などを使わない理由は、BT.709 の色域外の彩度が高い領域で人間の視覚特性とマッチしない箇所があるためである。

さて、Gamut Mapping は以下の3つの要素から成り立っている。このうち Hue Mapping は冒頭で述べた理由により実装しない。

* Lightness Mapping
* Chroma Mapping
* Hue Mapping

Lightness Mapping と Chroma Mapping の概要について説明する。この2つの Mapping は CIELAB色空間から算出できる Chroma-Lightness平面上で行う。この平面上で処理を行うことにより、Gamat Mapping で CIELAB色空間での Hue がは維持される。

では具体的に Chroma-Lightness平面上でどう Mapping をするのか説明していく。Mapping の方法は色々と考えられる。以下の図3に例を示す。

図3では3種類の Mapping を行っている。

1. Lightness 優先
2. Chroma 優先
3. BT.2407 Annex2



